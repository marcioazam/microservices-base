apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-ilm-policy
  namespace: platform
  labels:
    app: logging-service
data:
  ilm-policy.json: |
    {
      "policy": {
        "phases": {
          "hot": {
            "min_age": "0ms",
            "actions": {
              "rollover": {
                "max_size": "50gb",
                "max_age": "1d"
              },
              "set_priority": {
                "priority": 100
              }
            }
          },
          "warm": {
            "min_age": "7d",
            "actions": {
              "shrink": {
                "number_of_shards": 1
              },
              "forcemerge": {
                "max_num_segments": 1
              },
              "set_priority": {
                "priority": 50
              }
            }
          },
          "cold": {
            "min_age": "30d",
            "actions": {
              "searchable_snapshot": {
                "snapshot_repository": "logs-archive"
              },
              "set_priority": {
                "priority": 0
              }
            }
          },
          "delete": {
            "min_age": "365d",
            "actions": {
              "delete": {}
            }
          }
        }
      }
    }
  index-template.json: |
    {
      "index_patterns": ["logs-*"],
      "template": {
        "settings": {
          "number_of_shards": 3,
          "number_of_replicas": 1,
          "index.lifecycle.name": "logs-retention-policy",
          "index.lifecycle.rollover_alias": "logs"
        },
        "mappings": {
          "properties": {
            "id": { "type": "keyword" },
            "timestamp": { "type": "date" },
            "correlationId": { "type": "keyword" },
            "serviceId": { "type": "keyword" },
            "level": { "type": "keyword" },
            "message": {
              "type": "text",
              "analyzer": "standard",
              "fields": {
                "keyword": { "type": "keyword", "ignore_above": 256 }
              }
            },
            "traceId": { "type": "keyword" },
            "spanId": { "type": "keyword" },
            "userId": { "type": "keyword" },
            "requestId": { "type": "keyword" },
            "method": { "type": "keyword" },
            "path": { "type": "keyword" },
            "statusCode": { "type": "integer" },
            "durationMs": { "type": "long" },
            "metadata": { "type": "object", "enabled": true },
            "exception": {
              "type": "object",
              "properties": {
                "type": { "type": "keyword" },
                "message": { "type": "text" },
                "stackTrace": { "type": "text", "index": false }
              }
            }
          }
        }
      }
    }
