# Secrets Management

## ⚠️ SECURITY WARNING

**NEVER commit secrets in plaintext to git!**

Previous versions of this repository contained `secret.yaml` files with plaintext secrets. These have been **REMOVED** (2026-01-09) to prevent credential leakage.

## Approach

This project uses **External Secrets Operator** to manage secrets securely:

1. Secrets are stored in **HashiCorp Vault** (production) or **AWS Secrets Manager** (cloud)
2. **External Secrets Operator** syncs secrets from Vault into Kubernetes Secrets
3. Applications reference standard Kubernetes Secrets (managed by ESO)

## Architecture

```
┌─────────────────┐
│  HashiCorp      │
│     Vault       │◄─── Secrets stored here (encrypted at rest)
└────────┬────────┘
         │
         │ Sync every 1 hour (configurable)
         │
         ▼
┌─────────────────┐
│  External       │
│  Secrets        │◄─── Kubernetes Operator
│  Operator       │
└────────┬────────┘
         │
         │ Creates/Updates
         │
         ▼
┌─────────────────┐
│  Kubernetes     │
│  Secret         │◄─── Standard K8s Secret (auto-managed)
└────────┬────────┘
         │
         │ Mounts as env/volume
         │
         ▼
┌─────────────────┐
│  Application    │
│  Pod            │◄─── Your service
└─────────────────┘
```

## Installation

### 1. Install External Secrets Operator

```bash
helm repo add external-secrets https://charts.external-secrets.io
helm repo update

helm install external-secrets \
   external-secrets/external-secrets \
    -n external-secrets-system \
    --create-namespace \
    --set installCRDs=true
```

### 2. Configure Vault Backend

Create a `SecretStore` or `ClusterSecretStore`:

```yaml
# deploy/kubernetes/external-secrets/vault-secret-store.yaml
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "https://vault.example.com:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets"
          serviceAccountRef:
            name: "external-secrets"
            namespace: "external-secrets-system"
```

### 3. Create ExternalSecret Resources

The Helm chart automatically creates `ExternalSecret` resources when `externalSecrets.enabled=true`:

```yaml
# Automatically generated by Helm template
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cache-service-secrets
  namespace: auth-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: cache-service-secrets  # K8s Secret name
    creationPolicy: Owner
  data:
    - secretKey: redis-password
      remoteRef:
        key: secret/auth-platform/cache-service
        property: redis-password
    - secretKey: jwt-secret
      remoteRef:
        key: secret/auth-platform/token-service
        property: jwt-secret
```

## Storing Secrets in Vault

### Via Vault CLI

```bash
# Login to Vault
vault login -method=kubernetes role=admin

# Store cache-service secrets
vault kv put secret/auth-platform/cache-service \
  redis-password="$(openssl rand -base64 32)" \
  jwt-secret="$(openssl rand -base64 64)" \
  encryption-key="$(openssl rand -hex 32)"

# Store crypto-service secrets
vault kv put secret/auth-platform/crypto-service \
  tls-cert="$(cat certs/crypto-service.crt)" \
  tls-key="$(cat certs/crypto-service.key)"
```

### Via Vault UI

1. Navigate to `https://vault.example.com:8200`
2. Login with your credentials
3. Go to `secret/auth-platform/`
4. Create new secret with key-value pairs

## Helm Configuration

Enable External Secrets in `values.yaml`:

```yaml
externalSecrets:
  enabled: true  # ✅ NOW DEFAULT
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
```

## Development/Testing

For local development without Vault:

### Option 1: Create Secrets Manually

```bash
kubectl create secret generic cache-service-secrets \
  --from-literal=redis-password=dev-password \
  --from-literal=jwt-secret=dev-jwt-secret \
  --from-literal=encryption-key=$(openssl rand -hex 32) \
  -n auth-system
```

### Option 2: Use Sealed Secrets (Bitnami)

```bash
# Install sealed-secrets controller
helm install sealed-secrets sealed-secrets/sealed-secrets -n kube-system

# Create sealed secret (safe to commit to git)
echo -n "my-password" | kubectl create secret generic cache-service-secrets \
  --dry-run=client \
  --from-file=redis-password=/dev/stdin \
  -o yaml | \
  kubeseal -o yaml > cache-service-sealed-secret.yaml

# Commit the sealed secret
git add cache-service-sealed-secret.yaml
```

### Option 3: Disable External Secrets

```yaml
# values-dev.yaml
externalSecrets:
  enabled: false  # Will fail if secrets don't exist
```

**WARNING**: Only use this for local development. Production MUST use External Secrets or Sealed Secrets.

## Secret Rotation

### Automatic Rotation

External Secrets Operator refreshes secrets every `refreshInterval` (default: 1h).

To force immediate rotation:

```bash
kubectl annotate externalsecret cache-service-secrets \
  force-sync="$(date +%s)" \
  -n auth-system
```

### Manual Rotation

1. Update secret in Vault:
   ```bash
   vault kv put secret/auth-platform/cache-service \
     redis-password="$(openssl rand -base64 32)"
   ```

2. Wait for refresh interval OR force sync (above)

3. Restart pods to pick up new secrets:
   ```bash
   kubectl rollout restart deployment cache-service -n auth-system
   ```

## Troubleshooting

### ExternalSecret not syncing

```bash
# Check ExternalSecret status
kubectl describe externalsecret cache-service-secrets -n auth-system

# Check operator logs
kubectl logs -n external-secrets-system \
  -l app.kubernetes.io/name=external-secrets

# Common issues:
# 1. Vault authentication failed
# 2. Secret path doesn't exist in Vault
# 3. SecretStore not found
# 4. RBAC permissions missing
```

### Secret not appearing in pod

```bash
# Check if K8s Secret was created
kubectl get secret cache-service-secrets -n auth-system -o yaml

# Check if secret is mounted
kubectl exec -it cache-service-xxx -n auth-system -- env | grep PASSWORD

# Check pod events
kubectl describe pod cache-service-xxx -n auth-system
```

## Security Best Practices

✅ **DO:**
- Store secrets in Vault/AWS Secrets Manager
- Use External Secrets Operator for K8s sync
- Rotate secrets regularly (every 90 days minimum)
- Use strong random passwords (32+ characters)
- Limit secret access with Vault policies
- Enable audit logging in Vault
- Use separate secrets per environment (dev/staging/prod)

❌ **DON'T:**
- Commit secrets to git (even encrypted)
- Share secrets via Slack/email
- Reuse secrets across environments
- Use default/weak passwords
- Store secrets in ConfigMaps
- Log secret values
- Mount secrets as environment variables (use files when possible)

## Migration from Old Approach

If you previously had `secret.yaml` files:

1. **Extract secrets** from old files (DON'T commit them!)
2. **Store in Vault** using commands above
3. **Enable External Secrets** in Helm values
4. **Delete old secret.yaml** files from git:
   ```bash
   git rm deploy/kubernetes/*/secret.yaml
   git commit -m "security: remove plaintext secrets, use External Secrets"
   ```
5. **Rewrite git history** to remove secrets from history:
   ```bash
   git filter-repo --path deploy/kubernetes/cache-service/secret.yaml --invert-paths
   git filter-repo --path deploy/kubernetes/crypto-service/secret.yaml --invert-paths
   ```

## References

- External Secrets Operator: https://external-secrets.io/
- HashiCorp Vault: https://www.vaultproject.io/
- Sealed Secrets: https://github.com/bitnami-labs/sealed-secrets
- OWASP Secrets Management: https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
