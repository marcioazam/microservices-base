{{- if .Values.sessionIdentityCore.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: session-identity-core
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: session-identity-core
    app.kubernetes.io/part-of: auth-platform
spec:
  replicas: {{ .Values.sessionIdentityCore.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: session-identity-core
  template:
    metadata:
      labels:
        app.kubernetes.io/name: session-identity-core
        app.kubernetes.io/part-of: auth-platform
      annotations:
        # Vault Agent Injector annotations - Requirements 1.1, 1.2, 1.3
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "session-identity-core"
        vault.hashicorp.com/agent-inject-status: "update"
        # Dynamic PostgreSQL credentials - Requirements 1.2
        vault.hashicorp.com/agent-inject-secret-db-credentials.env: "database/auth-platform/creds/auth-platform-readwrite"
        vault.hashicorp.com/agent-inject-template-db-credentials.env: |
          {{`{{- with secret "database/auth-platform/creds/auth-platform-readwrite" -}}`}}
          DATABASE_URL=ecto://{{`{{ .Data.username }}`}}:{{`{{ .Data.password }}`}}@postgres.auth-platform.svc:5432/auth_platform
          {{`{{- end -}}`}}
        # Redis credentials
        vault.hashicorp.com/agent-inject-secret-redis-credentials.env: "database/auth-platform/creds/auth-platform-redis"
        vault.hashicorp.com/agent-inject-template-redis-credentials.env: |
          {{`{{- with secret "database/auth-platform/creds/auth-platform-redis" -}}`}}
          REDIS_URL=redis://{{`{{ .Data.username }}`}}:{{`{{ .Data.password }}`}}@redis.auth-platform.svc:6379
          {{`{{- end -}}`}}
        # Service configuration
        vault.hashicorp.com/agent-inject-secret-config.env: "secret/data/auth-platform/config/session-identity/default"
        vault.hashicorp.com/agent-inject-template-config.env: |
          {{`{{- with secret "secret/data/auth-platform/config/session-identity/default" -}}`}}
          {{`{{- range $key, $value := .Data.data }}`}}
          {{`{{ $key | toUpper }}`}}={{`{{ $value }}`}}
          {{`{{- end }}`}}
          {{`{{- end -}}`}}
        # Linkerd injection - Requirements 3.2
        linkerd.io/inject: enabled
        config.linkerd.io/proxy-cpu-request: "100m"
        config.linkerd.io/proxy-memory-request: "20Mi"
    spec:
      serviceAccountName: session-identity-core
      containers:
        - name: session-identity-core
          image: "{{ .Values.sessionIdentityCore.image.repository }}:{{ .Values.sessionIdentityCore.image.tag }}"
          imagePullPolicy: {{ .Values.sessionIdentityCore.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 4000
              protocol: TCP
            - name: grpc
              containerPort: 8082
              protocol: TCP
            - name: metrics
              containerPort: 9092
              protocol: TCP
          env:
            - name: SERVICE_NAME
              value: session-identity-core
            - name: VAULT_ADDR
              value: "{{ .Values.vault.address }}"
            - name: SECRET_KEY_BASE
              valueFrom:
                secretKeyRef:
                  name: session-identity-secrets
                  key: secret-key-base
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "{{ .Values.global.observability.tracing.endpoint }}"
          envFrom:
            - secretRef:
                name: session-identity-vault-secrets
                optional: true
          resources:
            {{- toYaml .Values.sessionIdentityCore.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
      {{- with .Values.sessionIdentityCore.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
