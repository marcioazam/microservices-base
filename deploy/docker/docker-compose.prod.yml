# Production Environment Configuration
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# December 2025 Best Practices - Security Hardened

x-prod-deploy: &prod-deploy
  resources:
    limits:
      cpus: '2.0'
      memory: 1G
    reservations:
      cpus: '0.5'
      memory: 256M
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3
    window: 120s

x-prod-logging: &prod-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "5"
    compress: "true"

services:
  # ============================================
  # Platform Services - Production Configuration
  # ============================================
  
  logging-api:
    deploy:
      <<: *prod-deploy
      replicas: 3
    logging: *prod-logging
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      LOG_LEVEL: warn
    # No debug ports exposed
    ports:
      - "5000:8080"

  logging-worker:
    deploy:
      <<: *prod-deploy
      replicas: 2
    logging: *prod-logging
    environment:
      DOTNET_ENVIRONMENT: Production
      LOG_LEVEL: warn

  resilience-service:
    deploy:
      <<: *prod-deploy
      replicas: 3
    logging: *prod-logging
    environment:
      RESILIENCE_LOGGING_LEVEL: warn
      RESILIENCE_OPENTELEMETRY_ENVIRONMENT: production
    # Only gRPC port, no debug
    ports:
      - "50056:50056"

  cache-service:
    deploy:
      <<: *prod-deploy
      replicas: 3
    logging: *prod-logging
    environment:
      LOG_LEVEL: warn
      DEBUG_MODE: "false"
    # Only service ports, no debug
    ports:
      - "8085:8080"
      - "9095:9090"

  # ============================================
  # Auth Services - Production Configuration
  # ============================================
  
  auth-edge-service:
    deploy:
      <<: *prod-deploy
      replicas: 5
    logging: *prod-logging
    environment:
      LOG_LEVEL: warn
      DEBUG_MODE: "false"
      ENVIRONMENT: production
    # Only service ports
    ports:
      - "8080:8080"
      - "9090:9090"

  token-service:
    deploy:
      <<: *prod-deploy
      replicas: 5
    logging: *prod-logging
    environment:
      LOG_LEVEL: warn
      DEBUG_MODE: "false"
      ENVIRONMENT: production
    ports:
      - "8081:8081"
      - "9091:9091"

  session-identity-core:
    deploy:
      <<: *prod-deploy
      resources:
        limits:
          cpus: '4.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M
      replicas: 5
    logging: *prod-logging
    environment:
      LOG_LEVEL: warn
      MIX_ENV: prod
      ENVIRONMENT: production
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
    ports:
      - "4000:4000"
      - "8082:8082"
      - "9092:9092"

  iam-policy-service:
    deploy:
      <<: *prod-deploy
      replicas: 3
    logging: *prod-logging
    environment:
      LOG_LEVEL: warn
      DEBUG_MODE: "false"
      ENVIRONMENT: production
    ports:
      - "8083:8083"
      - "9093:9093"

  mfa-service:
    deploy:
      <<: *prod-deploy
      replicas: 3
    logging: *prod-logging
    environment:
      LOG_LEVEL: warn
      MIX_ENV: prod
      ENVIRONMENT: production
    ports:
      - "8084:8084"
      - "9094:9094"

  # ============================================
  # Infrastructure - Production Configuration
  # ============================================
  
  postgres:
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
    logging: *prod-logging
    # No external port exposure in production
    # Access via internal network only
    ports: []
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"

  redis:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
    logging: *prod-logging
    command: >
      redis-server 
      --appendonly yes 
      --maxmemory 1536mb 
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
      --rename-command FLUSHDB ""
      --rename-command FLUSHALL ""
      --rename-command DEBUG ""
    # No external port exposure
    ports: []

  elasticsearch:
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
    logging: *prod-logging
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
    # No external port exposure
    ports: []

  rabbitmq:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
    logging: *prod-logging
    # No management UI exposed in production
    ports: []

  # ============================================
  # Observability - Production Configuration
  # ============================================
  
  otel-collector:
    deploy:
      <<: *prod-deploy
      replicas: 2
    logging: *prod-logging
    # Only internal ports
    ports:
      - "4317:4317"
      - "4318:4318"

  prometheus:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    logging: *prod-logging
    # Internal access only
    ports: []

  grafana:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    logging: *prod-logging
    environment:
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-https://grafana.example.com}
      GF_SECURITY_COOKIE_SECURE: "true"
      GF_SECURITY_STRICT_TRANSPORT_SECURITY: "true"
    # Exposed via reverse proxy only
    ports:
      - "3000:3000"

  jaeger:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    logging: *prod-logging
    # Internal access only
    ports: []

  kibana:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    logging: *prod-logging
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      ELASTICSEARCH_USERNAME: elastic
      ELASTICSEARCH_PASSWORD: ${ELASTICSEARCH_PASSWORD}
    # Internal access only
    ports: []
