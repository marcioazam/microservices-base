# PR Review Bot - Automated Code Review
# AI-powered review, labeling, and quality checks

name: PR Review Bot

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ============================================
  # Auto-labeling based on changed files
  # ============================================
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

      - name: Label PR size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: 10
          s_label: 'size/S'
          s_max_size: 100
          m_label: 'size/M'
          m_max_size: 500
          l_label: 'size/L'
          l_max_size: 1000
          xl_label: 'size/XL'
          fail_if_xl: false
          message_if_xl: >
            This PR is quite large. Consider breaking it into smaller PRs for easier review.

  # ============================================
  # Code Quality Checks
  # ============================================
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for TODO/FIXME comments
        run: |
          TODOS=$(grep -rn "TODO\|FIXME\|XXX\|HACK" --include="*.rs" --include="*.go" --include="*.ex" --include="*.exs" . || true)
          if [ -n "$TODOS" ]; then
            echo "::warning::Found TODO/FIXME comments in the codebase"
            echo "$TODOS"
          fi

      - name: Check for large files
        run: |
          LARGE_FILES=$(find . -type f \( -name "*.rs" -o -name "*.go" -o -name "*.ex" \) -size +500k)
          if [ -n "$LARGE_FILES" ]; then
            echo "::warning::Found large source files that may need refactoring"
            echo "$LARGE_FILES"
          fi

      - name: Detect complexity issues
        uses: codeclimate/codeclimate-action@v1
        continue-on-error: true
        with:
          config_file: .codeclimate.yml

  # ============================================
  # PR Description Validation
  # ============================================
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            const checks = [];
            
            // Check for description
            if (body.length < 50) {
              checks.push('❌ PR description is too short (min 50 characters)');
            } else {
              checks.push('✅ PR has adequate description');
            }
            
            // Check for linked issues
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#\d+/i;
            if (issuePattern.test(body)) {
              checks.push('✅ PR links to an issue');
            } else {
              checks.push('⚠️ Consider linking to a related issue');
            }
            
            // Check for testing notes
            if (body.toLowerCase().includes('test') || body.toLowerCase().includes('verified')) {
              checks.push('✅ Testing information provided');
            } else {
              checks.push('⚠️ Consider adding testing notes');
            }
            
            // Check for breaking changes
            if (body.toLowerCase().includes('breaking change')) {
              checks.push('⚠️ This PR contains breaking changes');
            }
            
            const comment = `## PR Validation Checklist\n\n${checks.join('\n')}\n\n---\n*Automated check by PR Review Bot*`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('PR Validation Checklist')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment,
              });
            }

  # ============================================
  # Conventional Commits Check
  # ============================================
  conventional-commits:
    name: Conventional Commits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        uses: wagoid/commitlint-github-action@v5
        with:
          configFile: .commitlintrc.json
          failOnWarnings: false

  # ============================================
  # Auto-assign Reviewers
  # ============================================
  auto-assign:
    name: Auto Assign Reviewers
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'ready_for_review'
    steps:
      - uses: actions/checkout@v4

      - name: Auto-assign reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Define code owners by path
            const codeOwners = {
              'auth-edge-service': ['rust-team'],
              'token-service': ['rust-team', 'security-team'],
              'session-identity-core': ['elixir-team'],
              'iam-policy-service': ['go-team', 'security-team'],
              'mfa-service': ['elixir-team', 'security-team'],
              'deployment': ['platform-team'],
            };
            
            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            const reviewers = new Set();
            
            for (const file of files) {
              for (const [path, teams] of Object.entries(codeOwners)) {
                if (file.filename.startsWith(path)) {
                  teams.forEach(team => reviewers.add(team));
                }
              }
            }
            
            if (reviewers.size > 0) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  team_reviewers: Array.from(reviewers),
                });
                console.log(`Assigned reviewers: ${Array.from(reviewers).join(', ')}`);
              } catch (error) {
                console.log(`Could not assign team reviewers: ${error.message}`);
              }
            }

  # ============================================
  # Stale PR Check
  # ============================================
  stale-check:
    name: Check for Stale PRs
    runs-on: ubuntu-latest
    steps:
      - name: Check PR age
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const createdAt = new Date(pr.created_at);
            const now = new Date();
            const daysOld = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
            
            if (daysOld > 14) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['stale'],
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `⚠️ This PR has been open for ${daysOld} days. Please update or close if no longer needed.`,
              });
            }
